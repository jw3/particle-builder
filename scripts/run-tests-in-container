#!/usr/bin/env bash

cd "$( dirname "${BASH_SOURCE[0]}" )/.."

if [[ ! " ${BUILD_PLATFORM[@]} " =~ " unit-test " ]]; then
    # No need to build or run anything if 'unit-test' wasn't in the BUILD_PLATFORM array
    exit 0
fi

source scripts/build-test-image

printf "${GREEN}Running tests inside of container $DOCKER_IMAGE_NAME:$TEST_IMAGE_VERSION...${NC}\n"

# Do this only if running under Travis CI
if [[ ! -z $TRAVIS ]]; then
    EXTRA_ARG=-v /home/travis/build/.build/:/firmware/test/unit_tests/.build/
    rm -rf /home/travis/build/.build/*
    mkdir -p /home/travis/build/.build
fi

docker run --rm $EXTRA_ARG -w /firmware --env BUILD_PLATFORM="${BUILD_PLATFORM[*]}" $DOCKER_IMAGE_NAME:$TEST_IMAGE_VERSION /bin/run-tests
