#!/usr/bin/env bash

cd "$( dirname "${BASH_SOURCE[0]}" )/.."

source scripts/constants
source $FIRMWARE_PATH/.buildpackrc

OUT_DIRECTORY=$1
BUILD_ARGS_FILE="${OUT_DIRECTORY}/build_args"
BASE_TAGS="${OUT_DIRECTORY}/base_tags"
MAIN_TAGS="${OUT_DIRECTORY}/main_tags"
REF="${OUT_DIRECTORY}/ref"

BASE_VERSION="$(cat .git/short_ref)-${BUILDPACK_VERSION}-${BUILDPACK_VARIATION}"
MAIN_VERSION="$TAG-$(cat .git/short_ref)-${BUILDPACK_VERSION}-${BUILDPACK_VARIATION}"

cat << EOL > "${BUILD_ARGS_FILE}"
BUILDPACK_BASE=${BUILDPACK_BASE}
BUILDPACK_BASE_VERSION=${BUILDPACK_VERSION}-${BUILDPACK_VARIATION}
DEVICEOS_BASE_IMAGE=$DEVICEOS_BASE_IMAGE
DEVICEOS_VERSION=$TAG
BASE_VERSION=${BASE_VERSION}
MAIN_VERSION=${MAIN_VERSION}
EOL

echo "${BASE_VERSION}" > "${BASE_TAGS}"
echo "${MAIN_VERSION}" > "${MAIN_TAGS}"

for platform in "${RELEASE_PLATFORMS[@]}${PRERELEASE_PLATFORMS[@]}"
do
	# Check if this platform requires different buildpack variation
	VARIATION="BUILDPACK_VARIATION_PLATFORM_${platform^^}"
	if [ -z ${!VARIATION} ]; then
		BUILDPACK_TAG="${BUILDPACK_VERSION}-${BUILDPACK_VARIATION}"
	else
		BUILDPACK_TAG="${BUILDPACK_VERSION}-${!VARIATION}"
	fi

    BASE_VERSION="$(cat .git/short_ref)-${BUILDPACK_TAG}"
    MAIN_VERSION="$TAG-$(cat .git/short_ref)-${BUILDPACK_TAG}"

    cat << EOL > "${BUILD_ARGS_FILE}_${platform}"
BUILDPACK_BASE=${BUILDPACK_BASE}
BUILDPACK_BASE_VERSION=${BUILDPACK_TAG}
DEVICEOS_BASE_IMAGE=$DEVICEOS_BASE_IMAGE
DEVICEOS_VERSION=$TAG
BASE_VERSION=${BASE_VERSION}
MAIN_VERSION=${MAIN_VERSION}
EOL

    echo "${DEVICEOS_VERSION}-$platform" > "tags_$platform"

done

echo "${MAIN_VERSION}" > "${REF}"
